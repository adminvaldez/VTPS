<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valdez-Tech Smart Estimate</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #viewDiv {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      left: 350px;
    }

    #panel {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 350px;
      background: #111;
      color: white;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 4px 0 10px rgba(0,0,0,0.4);
    }

    h2 {
      margin-top: 0;
      color: #00d4ff;
    }

    select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }

    button {
      background: #00d4ff;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background: #00aacc;
    }

    .estimate-box {
      margin-top: 20px;
      padding: 15px;
      background: #222;
      border-radius: 6px;
    }
  </style>
</head>

<body>

<div id="panel">
  <h2>Valdez-Tech Estimate</h2>

  <label>Select Service:</label>
  <select id="serviceType">
    <option value="0.30">House Wash ($0.30 / sq ft)</option>
    <option value="0.20">Driveway Cleaning ($0.20 / sq ft)</option>
    <option value="0.35">Full Exterior Premium ($0.35 / sq ft)</option>
  </select>

  <div class="estimate-box">
    <p><strong>Address:</strong> <span id="address">--</span></p>
    <p><strong>Owner:</strong> <span id="owner">--</span></p>
    <p><strong>Building Area:</strong> <span id="area">--</span></p>
    <p><strong>Estimated Price:</strong> $<span id="price">--</span></p>
  </div>

  <button onclick="bookService()">Book This Service</button>
</div>

<div id="viewDiv"></div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/widgets/Search",
  "esri/layers/FeatureLayer",
  "esri/geometry/geometryEngine"
], function(Map, MapView, Search, FeatureLayer, geometryEngine) {

  const parcels = new FeatureLayer({
    url: "https://www.gis.hctx.net/arcgis/rest/services/HCAD/Parcels/MapServer/0",
    outFields: ["*"]
  });

  const structures = new FeatureLayer({
    url: "https://services2.arcgis.com/FiaPA4ga0iQKduv3/arcgis/rest/services/USA_Structures_View/FeatureServer/0",
    outFields: ["*"]
  });

  const map = new Map({
    basemap: "satellite",
    layers: [parcels, structures]
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [-95.3698, 29.7604],
    zoom: 12
  });

  const searchWidget = new Search({ view: view });
  view.ui.add(searchWidget, "top-right");

  let currentArea = 0;

  searchWidget.on("select-result", function(event) {

    const point = event.result.feature.geometry;

    parcels.queryFeatures({
      geometry: point,
      spatialRelationship: "intersects",
      returnGeometry: true,
      outFields: ["*"]
    }).then(function(parcelResults) {

      if (parcelResults.features.length === 0) return;

      const parcel = parcelResults.features[0];

      view.graphics.removeAll();

      parcel.symbol = {
        type: "simple-fill",
        color: [255, 255, 0, 0.2],
        outline: { color: "yellow", width: 2 }
      };

      view.graphics.add(parcel);

      structures.queryFeatures({
        geometry: parcel.geometry,
        spatialRelationship: "intersects",
        returnGeometry: true,
        outFields: ["*"]
      }).then(function(structResults) {

        let totalBuildingSqFt = 0;

        structResults.features.forEach(function(feature) {
          const areaSqMeters = geometryEngine.planarArea(feature.geometry, "square-meters");
          totalBuildingSqFt += areaSqMeters * 10.7639;
        });

        currentArea = totalBuildingSqFt;

        const owner = parcel.attributes["OWNERNAME"] || "N/A";
        const address = parcel.attributes["SITEADDR"] || "N/A";

        document.getElementById("address").innerText = address;
        document.getElementById("owner").innerText = owner;
        document.getElementById("area").innerText = totalBuildingSqFt.toFixed(0) + " sq ft";

        updatePrice();

      });

    });

  });

  document.getElementById("serviceType").addEventListener("change", updatePrice);

  function updatePrice() {
    const rate = parseFloat(document.getElementById("serviceType").value);
    const price = currentArea * rate;
    document.getElementById("price").innerText = price.toFixed(2);
  }

});

function bookService() {
  const address = document.getElementById("address").innerText;
  const price = document.getElementById("price").innerText;

  localStorage.setItem("estimateAddress", address);
  localStorage.setItem("estimatePrice", price);

  window.location.href = "booking.html";
}
</script>

</body>
</html>
